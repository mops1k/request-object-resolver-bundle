stages:
  - test
  - deploy

test:
  stage: test
  image: php:8.0-cli
  script:
    - apt-get update && apt-get install -qy unzip git
    - curl -sSf "https://getcomposer.org/installer" | php -- --filename=composer --install-dir=/usr/local/bin
    - composer update
    - vendor/bin/phpstan --memory-limit=-1 --no-progress
    - vendor/bin/phpunit
    - vendor/bin/ecs --no-error-table --no-progress-bar

test lowest deps:
  stage: test
  image: php:8.0-cli
  script:
    - apt-get update && apt-get install -qy unzip git
    - curl -sSf "https://getcomposer.org/installer" | php -- --filename=composer --install-dir=/usr/local/bin
    - composer update --prefer-lowest
    - vendor/bin/phpunit

deploy:
  stage: deploy
  image: php:8.0-cli
  when: always
  only:
    - tags
  script:
    - 'curl --header "Job-Token: $CI_JOB_TOKEN" --data tag=$CI_COMMIT_TAG "${CI_API_V4_URL}/projects/$CI_PROJECT_ID/packages/composer"'
